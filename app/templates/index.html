<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Creator</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='index.js') }}"></script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>


<body class="bg-gray-800">
    <div>

        {% include 'partials/sidebar.html' %}

        <div class="xl:pl-72">
            <main class="lg:pr-96">
                <!-- Course Creator list -->
                <div class="px-4 sm:px-6 lg:px-8">
                    <div class="sm:flex sm:items-center">
                        <div class="sm:flex-auto">
                            <h1 class="text-3xl font-semibold leading-6 text-white">Course Material</h1>
                            <p class="mt-2 text-sm text-gray-400">A list of all pages grouped by topic and course</p>
                        </div>
                    </div>
                    <div class="mt-8 flow-root">
                        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                                <ul id="table-body" role="list" class="divide-y divide-gray-100">
                                    <li id="initial-table-row" class="hidden relative flex justify-between py-5">
                                        <div class="flex gap-x-4 pr-6 sm:w-1/2 sm:flex-none">
                                            <div class="min-w-0 flex-auto">
                                                <p class="text-sm font-semibold leading-6 text-white">
                                                    <a class="page text-indigo-500" href="#">
                                                        <span class="absolute inset-x-0 -top-px bottom-0"></span>
                                                        Page Name
                                                    </a>
                                                </p>
                                                <p class="mt-1 flex text-xs leading-5 text-gray-200">
                                                    <a class="course relative truncate hover:underline">Course</a>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between gap-x-4 sm:w-1/2 sm:flex-none">
                                            <div class="hidden sm:block">
                                                <p class="chapter text-sm leading-6 text-white">Chapter</p>
                                                <div class="mt-1 flex items-center gap-x-1.5">
                                                    <div class="exists-icon flex-none rounded-full p-1">
                                                        <div class="h-1.5 w-1.5 rounded-full bg-current"></div>
                                                      </div>
                                                    <p class="exists-label text-xs leading-5 text-gray-200">Created</p>
                                                </div>
                                            </div>
                                            <svg class="h-5 w-5 flex-none text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            {% include 'partials/feed.html' %}
        </div>
    </div>

</body>

<script>
    // jQuery, what a blast from the past...
    const rowIds = []
    const logIds = []

    function displayTableData(data) {
        const rows = translateToTableRows(data)

        const tableBody = $('#table-body')
        const tableRow = $('#initial-table-row')
        // const tableGroup = $('#initial-table-group')



        let currentGroup = null
        console.log(rows)
        for (const row of rows) {
            if (rowIds.includes(row.id)) continue

            // if (row.group !== currentGroup) {
            //     const newGroup = tableGroup.clone()
            //     newGroup.removeClass('hidden')
            //     newGroup.find('th').text(row.group)
            //     tableBody.append(newGroup)

            //     currentGroup = row.group
            // }

            const newRow = tableRow.clone()
            newRow.removeClass('hidden')
            // newRow.find('td').eq(0).text(row.topic)
            // newRow.find('td').eq(1).text(row.course)
            // newRow.find('td').eq(2).text(row.chapter)
            // newRow.find('td').eq(3).text(row.page)
            // newRow.find('td').eq(4).find('a').attr('href', row.link)
            newRow.find('.course').text(`Course: ${row.course}`)
            newRow.find('.chapter').text(`Chapter: ${row.chapter}`)
            newRow.find('.page').text(row.page)
            newRow.find('.page').attr('href', `page/${row.id}`)

            if (row.exists) {
                newRow.find('.exists-icon').addClass('text-green-400 bg-green-400/10')
                newRow.find('.exists-label').text('Generated')
            } else {
                newRow.find('.exists-icon').addClass('text-rose-400 bg-rose-400/10')
                newRow.find('.exists-label').text('Not Generated')
            }

            // newRow.find('td').eq(4).find('a').attr('href', row.link)
            tableBody.append(newRow)

            rowIds.push(row.id)
        }
    }

    function displayActivity(data) {
        const logList = $('#log-list')
        const logLine = $('#initial-log-line')

        for (line of data) {
            const logId = line.substring(0, 23) // date timestamp
            if (logIds.includes(logId)) continue

            const lineColor = logColor(line)
            const displayText = displayLogText(line)
            const newLine = logLine.clone()

            newLine.removeClass('hidden')
            newLine.addClass(lineColor)
            newLine.text(displayText)
            logList.append(newLine)

            logIds.push(logId)
        }
    }

    function ajaxFetch(url, callback) {
        try {
            $.ajax({
                url: url,  // the endpoint on your Flask app
                type: 'POST',  // http method
                contentType: 'application/json',  // type of data being sent
                success: function (response) {  // A function to be called if the request succeeds
                    console.log("Success: ", url);
                    callback(response)
                },
                error: function (xhr) {
                    // Handle error
                    console.error("Error occurred: ", xhr);
                }
            });
        } catch (error) {
            console.error("Error occurred: ", xhr);
            alert("Error occurred: " + error);
        }
    }

    function fetchContent() {
        return ajaxFetch('/ajax-fetch-course-material', displayTableData)
    }

    function fetchActivity() {
        return ajaxFetch('/ajax-fetch-activity', displayActivity)
    }

    function startPolling() {
        setInterval(fetchContent, 1000);
        setInterval(fetchActivity, 1000);
    }

    $(document).ready(function() {
        fetchContent()
        fetchActivity()
    })
</script>

</html>